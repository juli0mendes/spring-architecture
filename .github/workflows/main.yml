name: Main CI â€” Build & Unit Tests

on:
  push:
    branches:
      - main

concurrency:
  group: main-ci-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build
        run: mvn -B -DskipTests=true clean package

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run unit tests
        run: mvn -B test

  release:
    name: Automated Release
    needs: [build, unit-tests]
    runs-on: ubuntu-latest

    steps:
      - name: Run Release Please
        uses: google-github-actions/release-please-action@v4
        with:
          release-type: java
          package-name: spring-boot-app
          default-branch: main

#  release:
#    name: Automated Release
#    needs: [build, unit-tests]
#    runs-on: ubuntu-latest
#    if: >
#      github.event_name == 'push' ||
#      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
#    steps:
#      - name: Checkout repository (full history and tags)
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - name: Set up Git for tagging
#        run: |
#          git config user.name "github-actions[bot]"
#          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
#
#      - name: Determine semantic version bump from commits
#        id: semver
#        run: |
#          set -euo pipefail
#          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
#          echo "Latest tag: $LATEST_TAG"
#          LATEST=${LATEST_TAG#v}
#          IFS='.' read -r MAJ MIN PATCH <<< "${LATEST}"
#          MAJ=${MAJ:-0}; MIN=${MIN:-0}; PATCH=${PATCH:-0}
#
#          if [ "$LATEST_TAG" = "0.0.0" ]; then
#            COMMITS=$(git log --pretty=%B --no-merges HEAD)
#          else
#            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=%B --no-merges)
#          fi
#
#          echo "Commits since tag:\n$COMMITS"
#
#          BUMP="none"
#          if echo "$COMMITS" | grep -E "BREAKING CHANGE" -qi || echo "$COMMITS" | grep -E "^[^\n]*!" -q; then
#            BUMP="major"
#          elif echo "$COMMITS" | grep -E "(^|\b)feat(\b|:|\()" -qi; then
#            BUMP="minor"
#          elif echo "$COMMITS" | grep -E "(^|\b)(fix|bug)(\b|:|\()" -qi; then
#            BUMP="patch"
#          else
#            echo "No conventional commit indication for a release. Skipping release." >&2
#            echo "bump=none" >> $GITHUB_OUTPUT
#            exit 0
#          fi
#
#          echo "Determined bump: $BUMP"
#
#          if [ "$BUMP" = "major" ]; then
#            MAJ=$((MAJ + 1)); MIN=0; PATCH=0
#          elif [ "$BUMP" = "minor" ]; then
#            MIN=$((MIN + 1)); PATCH=0
#          elif [ "$BUMP" = "patch" ]; then
#            PATCH=$((PATCH + 1))
#          fi
#
#          NEW_TAG="v${MAJ}.${MIN}.${PATCH}"
#          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
#          echo "bump=$BUMP" >> $GITHUB_OUTPUT
#
#      - name: Create tag and push release
#        if: steps.semver.outputs.bump != 'none'
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        run: |
#          set -euo pipefail
#          NEW_TAG=${{ steps.semver.outputs.new_tag }}
#          echo "Creating tag $NEW_TAG"
#          git tag -a "$NEW_TAG" -m "chore(release): $NEW_TAG"
#          git push origin "$NEW_TAG"
#
#          OWNER=$(echo "${GITHUB_REPOSITORY}" | cut -d"/" -f1)
#          REPO=$(echo "${GITHUB_REPOSITORY}" | cut -d"/" -f2)
#          BODY="Automated release $NEW_TAG\n\nTriggered by automated CI."
#
#          echo "Creating release for $NEW_TAG"
#          response=$(curl -s -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
#            https://api.github.com/repos/${OWNER}/${REPO}/releases \
#            -d "{\"tag_name\": \"${NEW_TAG}\", \"name\": \"${NEW_TAG}\", \"body\": \"${BODY}\", \"draft\": false, \"prerelease\": false}")
#
#          echo "$response" | jq -r '.html_url // .message'
#
#      - name: No release needed
#        if: steps.semver.outputs.bump == 'none'
#        run: echo "No release was required based on commit messages."

